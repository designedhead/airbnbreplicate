var te=Object.defineProperty,ne=Object.defineProperties;var re=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;var M=(e,n,t)=>n in e?te(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,u=(e,n)=>{for(var t in n||(n={}))ie.call(n,t)&&M(e,t,n[t]);if(I)for(var t of I(n))ae.call(n,t)&&M(e,t,n[t]);return e},y=(e,n)=>ne(e,re(n));import a from"react";import{FormField as se}from"@sanity/base/components";import oe,{set as le,unset as ce}from"@sanity/form-builder/PatchEvent";import{useId as ue}from"@reach/auto-id";import fe from"react-select/creatable";import de from"react-select";import{withDocument as pe}from"part:@sanity/form-builder";import P from"part:tags/components/select";import me from"part:@sanity/base/client";import{defer as k,from as V,pipe as be}from"rxjs";import{map as h,switchMap as q}from"rxjs/operators";import{Card as W}from"@sanity/ui";const ye=e=>e.jsonType!=="object",ge=e=>"to"in e||"of"in e&&e.of[0]&&"to"in e.of[0],j=e=>(e||(e=[]),e.flat(1/0).filter((n,t)=>{const r=JSON.stringify({label:n.label,value:n.value});return t===e.flat(1/0).findIndex(i=>JSON.stringify({label:i.label,value:i.value})===r)})),ve=({initialLoadingOptions:e={},initialState:n=!0})=>{const[t,r]=a.useState(e),[i,s]=a.useState(n);a.useEffect(()=>{let o=!1;if(Object.keys(t).length)for(const l in t)t[l]&&(o=!0);s(o)},[t]);const f=a.useCallback(o=>{r(l=>u(u({},l),o))},[]);return[i,t,f]},Te=({initialState:e=[]})=>{const[n,t]=a.useState(e),[r,i]=a.useState({});a.useEffect(()=>{const f=[];for(const o in r)Array.isArray(r[o])&&f.push(...r[o]);t(j(f))},[r]);const s=a.useCallback(f=>{i(o=>u(u({},o),f))},[]);return[n,r,s]},_e=({customLabel:e="label",customValue:n="value"})=>t=>y(u({},t),{_label_temp:t.label,_value_temp:t.value,label:t[e],value:t[n]});function $e({customLabel:e="label",customValue:n="value",isReference:t}){return r=>{if(t===!0)return{_ref:r._id,_type:"reference"};const i=y(u({},r),{[n]:r.value,[e]:r.label,label:r._label_temp,value:r._value_temp});return delete i._label_temp,delete i._value_temp,i.label===void 0&&delete i.label,i.value===void 0&&delete i.value,i}}const x=async({tags:e,customLabel:n="label",customValue:t="value"})=>{const r=_e({customLabel:n,customValue:t});if(e!=null)return Array.isArray(e)&&!e.length?[]:Array.isArray(e)&&"_ref"in e[0]&&"_type"in e[0]&&"_ref"in e[0]&&"_type"in e[0]?(await T.fetch("*[_id in $refs]",{refs:e.map(i=>i._ref)})).map(r):Array.isArray(e)?e.map(r):"_ref"in e&&"_type"in e?r(await T.fetch("*[_id == $ref][0]",{ref:e._ref})):r(e)},he=async e=>{const n=await x(e);return n===void 0?[]:Array.isArray(n)?n:[n]};function Ce({tags:e,customLabel:n="label",customValue:t="value",isMulti:r,isReference:i}){const s=$e({customLabel:n,customValue:t,isReference:i});if(e!==void 0)return r?(Array.isArray(e)||(e=[e]),e.map(s)):(Array.isArray(e)&&(e=e[0]),s(e))}const C=({customLabel:e="label",customValue:n="value"})=>be(h(t=>Array.isArray(t)?t.flat(1/0):t),q(t=>he({tags:t,customLabel:e,customValue:n})),h(t=>j(t))),B=({query:e,params:n,customLabel:t="label",customValue:r="value"})=>T.listen(e,n,Ee).pipe(q(()=>T.fetch(e,n)),C({customLabel:t,customValue:r}));function Ae({tags:e,isMulti:n,customLabel:t="label",customValue:r="value"}){const i=async()=>e;return k(()=>V(i())).pipe(C({customLabel:t,customValue:r}),h(s=>n?s:s[0]))}const Se=async e=>{const n=await e();return Array.isArray(n)?n:[n]},Oe=({predefinedTags:e,customLabel:n="label",customValue:t="value"})=>{const r=e instanceof Function?e:async()=>e;return k(()=>V(Se(r)).pipe(C({customLabel:n,customValue:t})))},we=({document:e,customLabel:n="label",customValue:t="value"})=>B({query:`
  *[ _type == $document && defined(@[$customLabel]) && defined(@[$customValue])] {
    _id,
    "value": @[$customValue],
    "label": @[$customLabel]
  }
  `,params:{document:e,customLabel:n,customValue:t},customLabel:n,customValue:t}),Re=({document:e,field:n,isMulti:t,customLabel:r="label",customValue:i="value"})=>B({query:`
  *[
    _type == $document &&
    defined(@[$field]) &&
    defined(@[$field][]) == $isMulti &&
    (
      (!$isMulti && defined(@[$field]->[$customLabel]) && defined(@[$field]->[$customValue])) ||
      (!$isMulti && defined(@[$field][$customLabel]) && defined(@[$field][$customValue])) ||
      ($isMulti && defined(@[$field][]->[$customLabel]) && defined(@[$field][]->[$customValue])) ||
      ($isMulti && defined(@[$field][][$customLabel]) && defined(@[$field][][$customValue]))
    ) 
  ][$field]
  `,params:{document:e,field:n,isMulti:t,customLabel:r,customValue:i},customLabel:r,customValue:i}),T=me.withConfig({apiVersion:"2022-03-28"}),Ee={includeResult:!1,includePreviousRevision:!1,visibility:"query",events:["welcome","mutation","reconnect"]},Le=()=>a.createElement(W,{padding:[3,3,4],marginBottom:[3,3,4],radius:2,shadow:1,tone:"caution"},"Tag References cannot be created inline. Please set the ",a.createElement("code",null,"allowCreate")," option explicitly to ",a.createElement("code",null,"false")," to remove this warning message."),Fe=()=>a.createElement(W,{padding:[3,3,4],marginBottom:[3,3,4],radius:2,shadow:1,tone:"caution"},"Tag References cannot have predefined tags. Please unset the ",a.createElement("code",null,"predefinedTags")," option to remove this warning message.");var Ne=pe(a.forwardRef((e,n)=>{const[t,r]=a.useState(void 0),[i,,s]=ve({}),[f,,o]=Te({}),{type:l,value:D,readOnly:G,markers:J,presence:N,onFocus:U,onBlur:z,onChange:_,document:H}=e,g=ye(l),v=ge(l),{predefinedTags:K=[],includeFromReference:A=!1,includeFromRelated:S=!1,customLabel:p="label",customValue:m="value",allowCreate:O=!0,onCreate:Q=async c=>({[p]:c,[m]:c}),reactSelectOptions:X={}}=l.options?l.options:{},Y=l.options&&O&&v,Z=l.options&&!!l.options.predefinedTags&&v;a.useEffect(()=>{const c={unsubscribe:()=>{}};let d=c,E=c,L=c,F=c;return s({selectedTags:!0,predefinedTags:!0,referenceTags:!0,relatedTags:!0}),d=Ae({tags:D,customLabel:p,customValue:m,isMulti:g}).subscribe(b=>{r(b),s({selectedTags:!1})}),E=Oe({predefinedTags:K,customLabel:p,customValue:m}).subscribe(b=>{o({predefinedTags:b}),s({predefinedTags:!1})}),typeof A=="string"?F=we({document:A,customLabel:p,customValue:m}).subscribe(b=>{o({referenceTags:b}),s({referenceTags:!1})}):s({referenceTags:!1}),typeof S=="string"?L=Re({document:H._type,field:S,isMulti:g,customLabel:p,customValue:m}).subscribe(b=>{o({relatedTags:b}),s({relatedTags:!1})}):s({relatedTags:!1}),()=>{d.unsubscribe(),E.unsubscribe(),L.unsubscribe(),F.unsubscribe()}},[]);const ee=a.useCallback(async c=>{s({handleCreate:!0});const d=await x({customLabel:p,customValue:m,tags:await Q(c)});Array.isArray(t)?$([...t,d]):$(d),s({handleCreate:!1})},[_,t]),$=a.useCallback(c=>{r(c);const d=Ce({tags:c,customLabel:p,customValue:m,isMulti:g,isReference:v});_(oe.from(d?le(d):ce(d)))},[_]),w=ue(),R=u({isLoading:i,onFocus:U,onBlur:z,ref:n,inputId:w,isMulti:g,options:f,value:t,onCreateOption:ee,onChange:$,isDisabled:G||i},X);return a.createElement(se,{description:l.description,title:l.title,__unstable_markers:J,__unstable_presence:N,inputId:w},Y&&a.createElement(Le,null),Z&&a.createElement(Fe,null),O&&!v?a.createElement(fe,y(u({},R),{components:P})):a.createElement(de,y(u({},R),{components:P})))}));export{Ne as default};
//# sourceMappingURL=Input.js.map
